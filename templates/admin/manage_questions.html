{% extends "base.html" %}

{% block title %}Manage Questions{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Manage Questions</h1>

    <!-- Filter Form -->
    <form method="GET" action="{{ url_for('admin.manage_questions') }}" class="mb-4">
        <div class="row g-3">
            <div class="col-md-2">
                <label for="degree" class="form-label">Degree</label>
                <select name="degree" id="degree" class="form-select">
                    <option value="">All Degrees</option>
                    <option value="Bpharm" {% if degree == 'Bpharm' %}selected{% endif %}>BPharm</option>
                    <option value="Dpharm" {% if degree == 'Dpharm' %}selected{% endif %}>DPharm</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="subject_id" class="form-label">Subject</label>
                <select name="subject_id" id="subject_id" class="form-select">
                    <option value="">All Subjects</option>
                    {% for subject in question_form.subject_id.choices %}
                        {% if subject[0] != 0 %}
                            <option value="{{ subject[0] }}" {% if subject_id == subject[0]|string %}selected{% endif %}>{{ subject[1] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="chapter" class="form-label">Chapter</label>
                <input type="text" name="chapter" id="chapter" class="form-control" value="{{ chapter }}" placeholder="Chapter">
            </div>
            <div class="col-md-2">
                <label for="difficulty" class="form-label">Difficulty</label>
                <select name="difficulty" id="difficulty" class="form-select">
                    <option value="">All Difficulties</option>
                    <option value="easy" {% if difficulty == 'easy' %}selected{% endif %}>Easy</option>
                    <option value="medium" {% if difficulty == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="hard" {% if difficulty == 'hard' %}selected{% endif %}>Hard</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="search_query" class="form-label">Search</label>
                <input type="text" name="search_query" id="search_query" class="form-control" value="{{ search_query }}" placeholder="Search questions">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
        </div>
    </form>

    <!-- Tabs for Single and Bulk Import -->
    <ul class="nav nav-tabs mb-4" id="questionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab" aria-controls="single" aria-selected="true">Add Single Question</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab" aria-controls="bulk" aria-selected="false">Bulk Import</button>
        </li>
    </ul>

    <div class="tab-content" id="questionTabsContent">
        <!-- Single Question Form -->
        <div class="tab-pane fade show active" id="single" role="tabpanel" aria-labelledby="single-tab">
            <form method="POST" action="{{ url_for('admin.manage_questions') }}">
                {{ question_form.hidden_tag() }}
                {{ question_form.form_action(value='single') }}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ question_form.question.id }}" class="form-label">Question</label>
                        {{ question_form.question(class="form-control", rows=2) }}
                        {% if question_form.question.errors %}
                            {% for error in question_form.question.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ question_form.subject_id.id }}" class="form-label">Subject</label>
                        {{ question_form.subject_id(class="form-select") }}
                        {% if question_form.subject_id.errors %}
                            {% for error in question_form.subject_id.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.option_a.id }}" class="form-label">Option A</label>
                        {{ question_form.option_a(class="form-control") }}
                        {% if question_form.option_a.errors %}
                            {% for error in question_form.option_a.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.option_b.id }}" class="form-label">Option B</label>
                        {{ question_form.option_b(class="form-control") }}
                        {% if question_form.option_b.errors %}
                            {% for error in question_form.option_b.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.option_c.id }}" class="form-label">Option C</label>
                        {{ question_form.option_c(class="form-control") }}
                        {% if question_form.option_c.errors %}
                            {% for error in question_form.option_c.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.option_d.id }}" class="form-label">Option D</label>
                        {{ question_form.option_d(class="form-control") }}
                        {% if question_form.option_d.errors %}
                            {% for error in question_form.option_d.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.correct_answer.id }}" class="form-label">Correct Answer</label>
                        {{ question_form.correct_answer(class="form-select") }}
                        {% if question_form.correct_answer.errors %}
                            {% for error in question_form.correct_answer.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.chapter.id }}" class="form-label">Chapter</label>
                        {{ question_form.chapter(class="form-control") }}
                        {% if question_form.chapter.errors %}
                            {% for error in question_form.chapter.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.difficulty.id }}" class="form-label">Difficulty</label>
                        {{ question_form.difficulty(class="form-select") }}
                        {% if question_form.difficulty.errors %}
                            {% for error in question_form.difficulty.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.is_previous_year.id }}" class="form-label">Previous Year Question</label>
                        {{ question_form.is_previous_year(class="form-check-input mt-2") }}
                        {% if question_form.is_previous_year.errors %}
                            {% for error in question_form.is_previous_year.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ question_form.previous_year.id }}" class="form-label">Previous Year</label>
                        {{ question_form.previous_year(class="form-control") }}
                        {% if question_form.previous_year.errors %}
                            {% for error in question_form.previous_year.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ question_form.topics.id }}" class="form-label">Topics (comma-separated)</label>
                        {{ question_form.topics(class="form-control") }}
                        {% if question_form.topics.errors %}
                            {% for error in question_form.topics.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ question_form.explanation.id }}" class="form-label">Explanation</label>
                        {{ question_form.explanation(class="form-control", rows=2) }}
                        {% if question_form.explanation.errors %}
                            {% for error in question_form.explanation.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">Add Question</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Bulk Import Form -->
        <div class="tab-pane fade" id="bulk" role="tabpanel" aria-labelledby="bulk-tab">
            <form method="POST" action="{{ url_for('admin.bulk_import_questions') }}" enctype="multipart/form-data" id="bulkImportForm">
                {{ bulk_form.hidden_tag() }}
                {{ bulk_form.form_action(value='bulk') }}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ bulk_form.csv_file.id }}" class="form-label">Upload CSV File</label>
                        {{ bulk_form.csv_file(class="form-control") }}
                        {% if bulk_form.csv_file.errors %}
                            {% for error in bulk_form.csv_file.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <small class="form-text text-muted">
                            <a href="{{ url_for('admin.download_sample_csv') }}">Download sample CSV</a>
                        </small>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ bulk_form.subject_id.id }}" class="form-label">Subject</label>
                        {{ bulk_form.subject_id(class="form-select", id="bulk_subject_id", required=True) }}
                        {% if bulk_form.subject_id.errors %}
                            {% for error in bulk_form.subject_id.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary" id="bulkImportBtn">
                            <span id="bulkImportText">Import Questions</span>
                            <span id="bulkImportLoading" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Questions Table -->
    <h2 class="mt-5">Questions</h2>
    {% if questions %}
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Question</th>
                    <th>Subject</th>
                    <th>Degree</th>
                    <th>Chapter</th>
                    <th>Difficulty</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for question in questions %}
                    <tr>
                        <td>{{ (page - 1) * 10 + loop.index }}</td>
                        <td>{{ question.question|truncate(50) }}</td>
                        <td>{{ question.subject_name }}</td>
                        <td>{{ question.degree_type|capitalize }}</td>
                        <td>{{ question.chapter }}</td>
                        <td>{{ question.difficulty|capitalize }}</td>
                        <td>
                            <a href="{{ url_for('admin.edit_question', question_id=question.id) }}" class="btn btn-sm btn-warning">Edit</a>
                            <form action="{{ url_for('admin.delete_question', question_id=question.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this question?');">
                                {{ question_form.hidden_tag() }}
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.manage_questions', page=page-1, degree=degree, subject_id=subject_id, chapter=chapter, difficulty=difficulty, search_query=search_query) }}">Previous</a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('admin.manage_questions', page=p, degree=degree, subject_id=subject_id, chapter=chapter, difficulty=difficulty, search_query=search_query) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.manage_questions', page=page+1, degree=degree, subject_id=subject_id, chapter=chapter, difficulty=difficulty, search_query=search_query) }}">Next</a>
                </li>
            </ul>
        </nav>
    {% else %}
        <p>No questions found.</p>
    {% endif %}
</div>

<!-- JavaScript for Dynamic Subject Filtering -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const degreeSelect = document.getElementById('degree');
    const subjectSelect = document.getElementById('subject_id');
    const bulkSubjectSelect = document.getElementById('bulk_subject_id');

    function updateSubjects(degree, targetSelect) {
        fetch(`/admin/subjects/${degree}`)
            .then(response => response.json())
            .then(subjects => {
                targetSelect.innerHTML = '<option value="">All Subjects</option>';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    targetSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching subjects:', error);
            });
    }

    if (degreeSelect && subjectSelect) {
        degreeSelect.addEventListener('change', function() {
            const selectedDegree = this.value || 'all';
            updateSubjects(selectedDegree, subjectSelect);
        });

        // Initialize subjects based on selected degree
        const initialDegree = degreeSelect.value || 'all';
        updateSubjects(initialDegree, subjectSelect);
    }

    if (degreeSelect && bulkSubjectSelect) {
        degreeSelect.addEventListener('change', function() {
            const selectedDegree = this.value || 'all';
            updateSubjects(selectedDegree, bulkSubjectSelect);
        });

        // Initialize bulk import subjects
        const initialDegree = degreeSelect.value || 'all';
        updateSubjects(initialDegree, bulkSubjectSelect);
    }

    // Handle bulk import form submission
    const bulkImportForm = document.getElementById('bulkImportForm');
    const bulkImportBtn = document.getElementById('bulkImportBtn');
    const bulkImportText = document.getElementById('bulkImportText');
    const bulkImportLoading = document.getElementById('bulkImportLoading');

    if (bulkImportForm) {
        bulkImportForm.addEventListener('submit', function(event) {
            bulkImportBtn.disabled = true;
            bulkImportText.classList.add('d-none');
            bulkImportLoading.classList.remove('d-none');
        });
    }
});
</script>
{% endblock %}